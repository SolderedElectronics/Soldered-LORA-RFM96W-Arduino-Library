<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>16x2 easyC LCD Library: Adding a new region to Arduino LMIC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="custom_dark_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">16x2 easyC LCD Library<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">This is a library for the 16x2 easyC LCD Module</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_src_libs__m_c_c_i__lo_ra_w_a_n__l_m_i_c_library__h_o_w_t_o__a_d_d__r_e_g_i_o_n.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Adding a new region to Arduino LMIC </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This variant of the Arduino LMIC code supports adding additional regions beyond the eu868 and us915 bands supported by the original IBM LMIC 1.6 code.</p>
<p >This document outlines how to add a new region.</p>
<ul>
<li><a href="#planning">Planning</a><ul>
<li><a href="#determine-the-regionregion-category">Determine the region/region category</a></li>
<li><a href="#check-whether-the-region-is-already-listed-in-lmic_config_preconditionsh">Check whether the region is already listed in <code>lmic_config_preconditions.h</code></a></li>
</ul>
</li>
<li><a href="#make-the-appropriate-changes-in-lmic_config_preconditionsh">Make the appropriate changes in <code>lmic_config_preconditions.h</code></a></li>
<li><a href="#document-your-region-in-readmemd">Document your region in <code>README.md</code></a></li>
<li><a href="#add-the-definitions-for-your-region-in-lorabaseh">Add the definitions for your region in <code>lorabase.h</code></a></li>
<li><a href="#edit-lmic_bandplanh">Edit <code>lmic_bandplan.h</code></a></li>
<li><a href="#create-codelmic_emnewregionemccode">Create <code>lmic_<em>newregion</em>.c</code></a></li>
<li><a href="#general-discussion">General Discussion</a></li>
<li><a href="#adding-the-region-to-the-arduino_lorawan-library">Adding the region to the Arduino_LoRaWAN library</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md41"></a>
Planning</h1>
<h2><a class="anchor" id="autotoc_md42"></a>
Determine the region/region category</h2>
<p >Compare the target region (in the LoRaWAN regional specification) to the EU868 and US915 regions. There are three possibilities.</p>
<ol type="1">
<li>The region is like the EU region. There are a limited number of channels (up to 8), and only a small number of channels are used for OTAA join operations. The response masks refer to individual channels, and the JOIN-response can send frequencies of specific channels to be added.</li>
<li>The region is like the US region. There are many channels (the US has 64) with fixed frequencies, and the channel masks refer to subsets of the fixed channels.</li>
<li>The region is not really like either the EU or US. At the moment, it seems that CN470-510MHz (section 2.6 of LoRaWAN Regional Parameters spec V1.0.2rB) falls into this category.</li>
</ol>
<p >Band plans in categories (1) and (2) are easily supported. Band plans in category (3) are not supported by the current code.</p>
<h2><a class="anchor" id="autotoc_md43"></a>
Check whether the region is already listed in &lt;tt&gt;lmic_config_preconditions.h&lt;/tt&gt;</h2>
<p >Check <code><a class="el" href="lmic__config__preconditions_8h.html">src/lmic/lmic_config_preconditions.h</a></code> and scan the <code>LMIC_REGION_...</code> definitions. The numeric values are assigned based on the subchapter in section 2 of the LoRaWAN 1.0.2 Regional Parameters document. If your symbol is already there, then the first part of adaptation has already been done. There will already be a corresponding <code>CFG_...</code> symbol. But if your region isn't supported, you'll need to add it here.</p>
<ul>
<li><code>LMIC_REGION_myregion</code> must be a distinct integer, and must be less than 32 (so as to fit into a bitmask)</li>
</ul>
<h1><a class="anchor" id="autotoc_md44"></a>
Make the appropriate changes in &lt;tt&gt;lmic_config_preconditions.h&lt;/tt&gt;</h1>
<ul>
<li><code>LMIC_REGION_SUPPORTED</code> is a bit mask of all regions supported by the code. Your new region must appear in this list.</li>
<li><code>CFG_LMIC_REGION_MASK</code> is a bit mask that, when expanded, returns a bitmask for each defined <code>CFG_...</code> variable. You must add your <code>CFG_myregion</code> symbol to this list.</li>
<li><code>CFG_region</code> evaluates to the <code>LMIC_REGION_...</code> value for the selected region (as long as only one region is selected). The header files check for this, so you don't have to.</li>
<li><code>CFG_LMIC_EU_like_MASK</code> is a bitmask of regions that are EU-like, and <code>CFG_LMIC_US_like_MASK</code> is a bitmask of regions that are US-like. Add your region to the appropriate one of these two variables.</li>
</ul>
<h1><a class="anchor" id="autotoc_md45"></a>
Document your region in &lt;tt&gt;README.md&lt;/tt&gt;</h1>
<p >You'll see where the regions are listed. Add yours.</p>
<h1><a class="anchor" id="autotoc_md46"></a>
Add the definitions for your region in &lt;tt&gt;lorabase.h&lt;/tt&gt;</h1>
<ul>
<li>If your region is EU like, copy the EU block. Document any duty-cycle limitations.</li>
<li>if your region is US like, copy the US block.</li>
<li>As appropriate, copy <code><a class="el" href="lorabase__eu868_8h.html">lorabase_eu868.h</a></code> or <code><a class="el" href="lorabase__us915_8h.html">lorabase_us915.h</a></code> to make your own <code>lorabase_<em>newregion</em>.h</code>. Fill in the symbols.</li>
</ul>
<p >At time of writing, you need to duplicate some code to copy some settings from <code><a class="el" href="lorabase__eu868_8h.html">lorabase_eu868.h</a></code> or <code><a class="el" href="lorabase__us915_8h.html">lorabase_us915.h</a></code> to the new file; and you need to put some region-specific knowledge into the <code><a class="el" href="lorabase_8h.html">lorabase.h</a></code> header file. The long-term direction is to put all the regional knowledge into the region-specific header, and then the central code will just copy. The architectural impulse is that we'll want to be able to reuse the regional header files in other contexts. On the other hand, because it's error prone, we don't want to <code>#include</code> files that aren't being used; otherwise you could accidentally use EU parameters in US code, etc.</p>
<ul>
<li><p class="startli">Now's a good time to test-compile and clean out errors introduced. Make sure you set the region to your new target region. You'll have problems compiling, but they should look like this:</p>
<div class="fragment"><div class="line">lmic.c:29: In file included from</div>
<div class="line"> </div>
<div class="line">lmic_bandplan.h: 52:3: error: #error &quot;LMICbandplan_maxFrameLen() not defined by bandplan&quot;</div>
<div class="line">   # error &quot;LMICbandplan_maxFrameLen() not defined by bandplan&quot;</div>
<div class="line"> </div>
<div class="line">lmic_bandplan.h: 56:3: error: #error &quot;pow2dBm() not defined by bandplan&quot;</div>
<div class="line">   # error &quot;pow2dBm() not defined by bandplan&quot;</div>
</div><!-- fragment --></li>
<li>If using an MCCI BSP, you might want to edit your local copy of <code>boards.txt</code> to add the new region.</li>
<li>If using an MCCI BSP, you should definitely edit the template files to add the new region to the list.</li>
<li>Modify the <code>.travis.yml</code> file to test the new region.</li>
</ul>
<h1><a class="anchor" id="autotoc_md47"></a>
Edit &lt;tt&gt;lmic_bandplan.h&lt;/tt&gt;</h1>
<p >The next step is to add the region-specific interfaces for your region.</p>
<p >Do this by editing <code><a class="el" href="lmic__bandplan_8h.html">lmic_bandplan.h</a></code> and adding the appropriate call to a (new) region-specific file <code>lmic_bandplan_myregion.h</code>, where "myregion" is the abbreviation for your region.</p>
<p >Then, if your region is eu868-like, copy <code><a class="el" href="lmic__bandplan__eu868_8h.html">lmic_bandplan_eu868.h</a></code> to create your new region-specific header file; otherwise copy <code><a class="el" href="lmic__bandplan__us915_8h.html">lmic_bandplan_us915.h</a></code>.</p>
<p >Edit the file.</p>
<p >Try to compile again; you should now get link errors related to your new band-plan, like this:</p>
<div class="fragment"><div class="line">c:\tmp\buildfolder\libraries\arduino-lmic\lmic\lmic.c.o: In function `lowerDR&#39;:</div>
<div class="line"> </div>
<div class="line">C:\Users\tmm\Documents\Arduino\libraries\arduino-lmic\src\lmic/lorabase.h:667: undefined reference to `constant_table__DR2RPS_CRC&#39;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md48"></a>
Create &lt;code&gt;lmic_&lt;em&gt;newregion&lt;/em&gt;.c&lt;/code&gt;</h1>
<p >Once again, you will start by copying either <code><a class="el" href="lmic__eu868_8c.html">lmic_eu868.c</a></code> or <code><a class="el" href="lmic__us915_8c.html">lmic_us915.c</a></code> to create your new file. Then touch it up as necessary.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
General Discussion</h1>
<ul>
<li>You'll find it easier to do the test compiles using the example scripts in this directory, rather than trying to get all the Catena framework going too. On the other hand, working with the Catena framework will expose more problems.</li>
<li>Don't forget to check and update the examples.</li>
<li>You will also need to update the <code>boards.template</code> file for MCCI BSPs, in order to get the region to show up in the Arduino IDE menu.</li>
<li>You will need to update the <a href="https://github.com/mcci-catena/arduino-lorawan"><code>arduino-lorawan</code></a> library to include support for the new region. (See <a href="#adding-the-region-to-the-arduino_lorawan-library">below</a> for instructions.)</li>
<li>Please increase the version of <code>arduino-lmic</code> (symbol <code>ARDUINO_LMIC_VERSION</code> in <code><a class="el" href="lmic_2lmic_8h.html" title="LMIC API.">src/lmic/lmic.h</a></code>), and change <code>arduino-lorawan</code>'s <code>Arduino_LoRaWAN_lmic.h</code> to check for at least that newer version.</li>
<li>Please also increase the version of the <code>arduino-lorawan</code> library (symbol <code>ARDUINO_LORAWAN_VERSION</code>).</li>
</ul>
<h1><a class="anchor" id="autotoc_md50"></a>
Adding the region to the Arduino_LoRaWAN library</h1>
<p >In <code>Arduino_LoRaWAN_ttn.h</code>:</p>
<ul>
<li>Add a new class with name <code>Arduino_LoRaWAN_ttn_myregion</code>, copied either from the <code>Arduino_LoRaWAN_ttn_eu868</code> class or the <code>Arduino_LoRaWAN_ttn_us915</code> class.</li>
<li>Extend the list of <code>#if defined(CFG_eu868)</code> etc. to define <code>Arduino_LoRaWAN_REGION_TAG</code> to the suffix of your new class if <code>CFG_myregion</code> is defined.</li>
</ul>
<p >Then copy and edit either <code>ttn_eu868_netbegin.cpp</code>/<code>ttn_eu868_netjoin.cpp</code> or <code>ttn_us915_netbegin.cpp</code>/<code>ttn_us915_netjoin.cpp</code> to make your own file(s) for the key functions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath">
    <!-- id is needed for treeview function! -->
    <ul>
        <li class="footer">
            Generated on Tue Jan 18 2022 11:28:01 for 16x2 easyC LCD Library by <a href="http://www.doxygen.org/index.html">
                <img class="footer" src="doxygen.png" alt="doxygen"
                    onerror="this.onerror=null;this.src='doxygen.svg';" /></a> 1.9.2.
            Dark theme by <a href="http://majerle.eu" target="_new">Tilen Majerle</a>. All rights reserved.
            Copyright: <a href="https://www.soldered.com">Soldered</a>
        </li>
    </ul>
</div>
<script src="custom.js"></script>
</body>
</html>
